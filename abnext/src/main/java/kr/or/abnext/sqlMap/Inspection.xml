<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="inspection">
	<select id="getNextKey" resultType="java.lang.String">
		SELECT AUTO_INCREMENT
		  FROM INFORMATION_SCHEMA.TABLES
		 WHERE TABLE_SCHEMA = 'avinext'
		   AND TABLE_NAME = 'TB_RCEPT'
	</select>

	<select id="selectDoctorList" parameterType="kr.or.abnext.domain.TbUser" resultType="kr.or.abnext.domain.TbUser">
		SELECT *
		  FROM TB_USER
		 WHERE HOSP_NO = (SELECT HOSP_NO FROM TB_USER WHERE USER_ID = #{userId})
		   AND USER_LEV = '2'
	</select>

	<insert id="insertRcept" parameterType="kr.or.abnext.domain.TbRcept">
		INSERT
		  INTO TB_RCEPT
		     (
		       RQST_NO       , HOSP_NO        , HOSP_NM
		     , USER_NO       , USER_NM        , ANIM_NO        , ANIM_NM
		     , DOC_NO        , DOC_NM
		     , ANIM_BUTLER   , BUTLER_SIDO    , BUTLER_SIGUNGU , BUTLER_SIGUNGU_CD
		     , ANIM_FIRST_CD , ANIM_SECOND_CD , ANIM_THIRD_CD
		     , ANIM_BIRTH    , ANIM_SEX       , RQST_DT        , RQST_MEMO
		     , PROC_STAT     , PROC_STAT_NM
		     , PAY_GB        , PRICE          , PAY_STAT
		     , INS_DT        , INS_ID
		     )
		VALUES
		     (
		       #{rqstNo}       , #{hospNo}        , #{hospNm}
		     , #{userNo}       , #{userNm}        , #{animNo}        , #{animNm}
		     , #{docNo}        , #{docNm}
		     , #{animButler}   , #{butlerSido}    , #{butlerSigungu} , #{butlerSigunguCd}
		     , #{animFirstCd}  , #{animSecondCd}  , #{animThirdCd}
		     , #{animBirth}    , #{animSex}       , NOW()            , #{rqstMemo}
		     , #{procStat}     , #{procStatNm}
		     , #{payGb}        , #{price}         , #{payStat}
		     , NOW()           , #{insId}
		     )
	</insert>

	<insert id="insertInspection" parameterType="kr.or.abnext.domain.TbInspection">
		INSERT
		  INTO TB_INSPECTION
		     (
		       RQST_NO       , SAMPLE_CODE
		     , INSP_FIRST_CD , INSP_SECOND_CD , INSP_THIRD_CD , INSP_PRICE
		     , INS_DT        , INS_ID
		     )
		VALUES
		     (
		       #{rqstNo}      , #{sampleCode}
		     , #{inspFirstCd} , #{inspSecondCd} , #{inspThirdCd} , #{inspPrice}
		     , NOW()          , #{insId}
		     )
	</insert>

	<insert id="insertSample" parameterType="kr.or.abnext.domain.TbSample">
		INSERT
		  INTO TB_SAMPLE
		     (
		       RQST_NO       , SAMPLE_CODE    , SAMPLE_MEMO
		     , INS_DT        , INS_ID
		     )
		VALUES
		     (
		       #{rqstNo}      , #{sampleCode} , #{sampleMemo}
		     , NOW()          , #{insId}
		     )
	</insert>

	<select id="selectRceptList" parameterType="kr.or.abnext.domain.TbRcept" resultType="kr.or.abnext.domain.TbRcept">
		SELECT A.*
		  FROM TB_RCEPT A
		 WHERE PROC_STAT IN
		<foreach item="arr" collection="array" open="(" separator="," close=")">
        	#{arr}
  		</foreach>
	</select>

	<select id="selectInspList" parameterType="kr.or.abnext.domain.TbInspection" resultType="kr.or.abnext.domain.TbInspection">
		SELECT A.*
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.INSP_FIRST_CD) AS INSP_FIRST_NM
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.INSP_SECOND_CD) AS INSP_SECOND_NM
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.INSP_THIRD_CD) AS INSP_THIRD_NM
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.INSP_TYPE) AS INSP_TYPE_NM
		  FROM TB_INSPECTION A
		 WHERE RQST_NO = #{rqstNo}
	</select>

	<select id="selectSampleList" parameterType="kr.or.abnext.domain.TbSample" resultType="kr.or.abnext.domain.TbSample">
		SELECT A.*
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.SAMPLE_CODE) AS SAMPLE_NAME
		  FROM TB_SAMPLE A
		 WHERE RQST_NO = #{rqstNo}
	</select>

	<select id="getTbRcept" parameterType="kr.or.abnext.domain.TbRcept" resultType="kr.or.abnext.domain.TbRcept">
		SELECT A.*
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.ANIM_FIRST_CD) AS ANIM_FIRST_NM
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.ANIM_SECOND_CD) AS ANIM_SECOND_NM
		     , (SELECT CODE_NM FROM TB_CODE B WHERE B.CODE_ID = A.ANIM_THIRD_CD) AS ANIM_THIRD_NM
		  FROM TB_RCEPT A
		 WHERE RQST_NO = #{rqstNo}
	</select>

	<select id="getUser" parameterType="kr.or.abnext.domain.TbUser" resultType="kr.or.abnext.domain.TbUser">
		SELECT *
		  FROM TB_USER
		 WHERE USER_NO = #{userNo}
	</select>

	<select id="getAnimal" parameterType="kr.or.abnext.domain.TbAnimal" resultType="kr.or.abnext.domain.TbAnimal">
		SELECT *
		  FROM TB_ANIMAL
		 WHERE ANIM_NM = #{animNm}
		   AND ANIM_BIRTH = #{animBirth}
		   AND USER_NM = #{userNm}
		   AND SIGUNGU_CD = #{sigunguCd}
	</select>

	<select id="duplAnimChk" parameterType="kr.or.abnext.domain.TbAnimal" resultType="int">
		SELECT COUNT(*)
		  FROM TB_ANIMAL
		 WHERE ANIM_NM = #{animNm}
		   AND ANIM_BIRTH = #{animBirth}
		   AND USER_NM = #{userNm}
		   AND SIGUNGU_CD = #{sigunguCd}
	</select>

	<insert id="insertAnimal" parameterType="kr.or.abnext.domain.TbAnimal">
		INSERT
		  INTO TB_ANIMAL
		     (
		       ANIM_NO       , ANIM_NM
		     , ANIM_FIRST_CD , ANIM_SECOND_CD , ANIM_THIRD_CD
		     , ANIM_BIRTH    , ANIM_SEX       , MEMO
		     , USER_NM       , SIGUNGU_CD
		     , INS_DT        , INS_ID
		     )
		VALUES
		     (
		       #{animNo}      , #{animNm}
		     , #{animFirstCd} , #{animSecondCd} , #{animThirdCd}
		     , #{animBirth}   , #{animSex}      , #{memo}
		     , #{userNm}      , #{sigunguCd}
		     , NOW()          , #{insId}
		     )
	</insert>

	<update id="updateInspectStatus" parameterType="kr.or.abnext.domain.TbRcept">
		UPDATE TB_RCEPT
		   SET PROC_STAT = #{procStat}
		     , PROC_STAT_NM = #{procStatNm}
		     , ANIM_NO = #{animNo}
		     , UPT_ID = #{uptId}
		     , UPT_DT = NOW()
		 WHERE RQST_NO = #{rqstNo}
	</update>

	<update id="updateSampleStatus" parameterType="kr.or.abnext.domain.TbSample">
		UPDATE TB_SAMPLE
		   SET SAMPLE_STATUS = #{sampleStatus}
		     , UPT_ID = #{uptId}
		     , UPT_DT = NOW()
		 WHERE SAMPLE_NO = #{sampleNo}
	</update>

	<update id="updateInspect" parameterType="kr.or.abnext.domain.TbInspection">
		UPDATE TB_INSPECTION
		   SET UPT_ID = #{uptId}
		     , UPT_DT = NOW()
		<if test="inspType != null and inspType != ''">
		     , INSP_TYPE = #{inspType}
		</if>
		<if test="inspFirstCd != null and inspFirstCd != ''">
		     , INSP_FIRST_CD = #{inspFirstCd}
		</if>
		<if test="sampleCode != null and sampleCode != ''">
		     , SAMPLE_CODE = #{sampleCode}
		</if>
		<if test="sampleName != null and sampleName != ''">
		     , SAMPLE_NAME = #{sampleName}
		</if>
		<if test="workerNo != null and workerNo != ''">
		     , WORKER_NO = #{workerNo}
		</if>
		<if test="workerNm != null and workerNm != ''">
		     , WORKER_NM = #{workerNm}
		</if>
		 WHERE INSP_NO = #{inspNo}
	</update>
</mapper>